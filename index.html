<!DOCTYPE html>
<html lang = "en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Variant Search Tool</title>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
        <script src="https://unpkg.com/ag-grid-community/dist/ag-grid-community.min.js"></script>
        <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-grid.css">
        <link rel="stylesheet" href="https://unpkg.com/ag-grid-community/dist/styles/ag-theme-balham.css">
        <style>
            html {
                height: 100%;
                width: 100%;
            }

            body {
                height: 100%;
            }
            
            .grid-header {
                background-color:lightskyblue;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            }
            
            .title-element {
                margin: 3px;
                padding: 3px;
                background-color: aliceblue;
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                font-size: 20px;
            }

            .grid-body {
                background-color: aliceblue;
            }

            div {
                padding: 2px;
            }

            .col-container {
                padding: 0px;
                text-align: center;
            }

            .col-highlight {
                background-color: lightslategrey;
            }

            .page-label {
                font-size: 13px;
                font-style: italic;
                color:gray;
                padding: 4px;
            }

            .suggestion-container {
                position: absolute;
                border: 1px solid #d4d4d4;
                padding: 0px;
                border-bottom: none;
                border-top: none;
                z-index: 99;
                top: 100%;
                left: 0;
                right: 0;
                max-height: 200px;
                overflow: scroll;
            }

            .suggestion-container div{
                cursor: pointer;
                background-color: whitesmoke;
                border: #07060616 solid 1px;
            }

            .suggestion-container div:hover {
                background-color:lightsteelblue;
            }
        </style>
    </head>
    <body>
        <script>
            (function() {
                const port = 3000;
                const url = `http://localhost:${port}`;
                let offset = 0;
                let totalResults = 0;
                let batch = 30;
                
                
                const columns = {
                    'gene': 'gene',
                    'nucleotideChange': 'nucleotide_change',
                    'proteinChange': 'protein_change',
                    'alias': 'alias',
                    'region': 'region',
                    'reportedClassification': 'reported_classification',
                    'lastEvaluated': 'last_evaluated',
                    'lastUpdated': 'last_updated',
                    'source': 'source'
                };
                
                const columnDefs = [
                    {headerName: 'Gene', field: 'gene', sortable: true, filter: true},
                    {headerName: 'Nucleotide Change', field: 'nucleotideChange', sortable: true, filter: true},
                    {headerName: 'Protein Change', field: 'proteinChange', sortable: true, filter: true},
                    {headerName: 'Alias', field: 'alias', sortable: true, filter: true},
                    {headerName: 'Region', field: 'region', sortable: true, filter: true},
                    {headerName: 'Reported Classification', field: 'reportedClassification', sortable: true, filter: true},
                    {headerName: 'Last Evaluated', field: 'lastEvaluated', sortable: true, filter: true},
                    {headerName: 'Last Updated', field: 'lastUpdated', sortable: true, filter: true},
                    {headerName: 'Source', field: 'source', sortable: true, filter: true}
                ];

                const gridOptions = {
                    columnDefs: columnDefs
                };
                
                function setUpDocument() {
                    setGrid();
                    loadAllRows();

                    //addHighlightListeners();
                }
                
                function setGrid() {
                    // let rowData = [{
                    //     gene: 'test',
                    //     nucleotideChange: 'another',
                    //     proteinChange: 'asdlfjh',
                    //     alias: 'dfsd',
                    //     region: 'asdjfn',
                    //     reportedClassification: 'askdjhs',
                    //     lastEvaluated: 'asdifuhr',
                    //     lastUpdated: '12-12-12',
                    //     source: 'asdfjh'
                    // }];
                    let gridDiv = document.querySelector('#grid');
                    new agGrid.Grid(gridDiv, gridOptions);
                }
                
                function searchGene() {
                    let element = document.getElementById('input-box');
                    let term = element.value;
                    requestGene(term);
                }
                
                function updatePaginationLabel() {
                    let batchSize = offset + batch;
                    let maxRange = totalResults <= batchSize ? totalResults : batchSize;
                    document.getElementById('paginate-label').innerText = `${offset + 1} - ${maxRange} of ${totalResults} results`;
                }
                
                function addHighlightListeners() {
                    columns.forEach(col => {
                        document.getElementById(col).addEventListener('mouseover', function() {
                            this.classList.add('col-highlight');
                        });
                    });
                }
                
                function resetColumns() {
                    for (let col in columns) {
                        document.getElementById(col).innerHTML = '';
                    }
                }
                
                function incrementPage() {
                    //send get request with same search request
                    //check to make sure no index error
                    let test = offset + batch;
                    if (test <= totalResults) {
                        let element = document.getElementById('input-box');
                        let term = element.value; 
                        offset += batch;
                        if ( term == null || term == ''){
                            loadAllRows();
                        }
                        else {
                            searchGene();
                        }
                    }
                    
                }

                function decrementPage() {
                    //same implementation as increment except opposite
                    let test = offset - batch;
                    if (test >= 0) {
                        let element = document.getElementById('input-box');
                        let term = element.value;
                        offset -= batch;
                        if ( term == null || term == ''){
                            loadAllRows();
                        }
                        else {
                            searchGene();
                        }
                    }
                }
                
                function requestSuggestions(term) {
                    let xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = () => {
                        if (xhttp.readyState === 4 && xhttp.status === 200) {
                            loadSuggestions(xhttp.responseText);
                        }
                    }
                    let endpoint = url + `/genes/autocomplete/${term}`;
                    xhttp.open('GET', endpoint, true);
                    xhttp.send();
                }
                
                function requestGene(geneName) {
                    let xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = () => {
                        if (xhttp.readyState === 4 && xhttp.status === 200) {
                            addData(xhttp.responseText);
                        }
                    }
                    let endpoint = url + `/genes/${geneName}?offset=${offset}&batch=${batch}`;
                    xhttp.open('GET', endpoint, true);
                    xhttp.send();
                }
                
                function loadAllRows() {
                    let xhttp = new XMLHttpRequest();
                    xhttp.onreadystatechange = () => {
                        if (xhttp.readyState === 4 && xhttp.status === 200) {
                            addData(xhttp.responseText);
                        }
                    }
                    let endpoint = `${url}/genes/all?offset=${offset}&batch=${batch}`;
                    xhttp.open('GET', endpoint, true);
                    xhttp.send();
                }

                function addData(responseText) {
                    responseBody = JSON.parse(responseText);
                    offset = responseBody['offset'];
                    totalResults = responseBody['totalResults'];
                    batch = responseBody['limit'];
                    let rows = responseBody['results'];
                    //resetColumns();
                    //updatePaginationLabel();
                    let rowData = [];
                    for (let i = 0; i < rows.length; i++) {
                        let rowObj = {};
                        for (let col in columns) {
                            rowObj[col] = rows[i][columns[col]];
                        }
                        rowData.push(rowObj);
                    }
                    gridOptions.api.setRowData(rowData);
                }

                function loadSuggestions(responseText) {
                    let response = JSON.parse(responseText).results;
                    let inputBox = document.getElementById('input-box');
                    let value = inputBox.value;
                    let genes = response.map(x => x.gene);
                    let entry;
                    //let inputBox = document.getElementById('input-box');
                    //create dropdown
                    let suggestionBox = document.createElement('div');
                    suggestionBox.classList.add('suggestion-container');
                    inputBox.parentNode.appendChild(suggestionBox);

                    for (let gene of genes) {
                        entry = document.createElement('div');
                        entry.innerHTML = `<strong>${gene.substr(0,value.length)}</strong>`;
                        entry.innerHTML += gene.substr(value.length);
                        entry.innerHTML += `<input type='hidden' value='${gene}'>`;
                        suggestionBox.appendChild(entry);
                    }
                }
                document.addEventListener('DOMContentLoaded', setUpDocument);
            })();
        </script>
        <div class="d-flex flex-column flex-grow">
            <div id="title" class="title-element">Variant Search Tool</div>
            <div class="d-flex flex-row">
                <div class="d-inline-flex flex-row mr-auto">
                    <div class="input-group input-group-sm">
                        <input id="input-box" type="text" placeholder="Enter a gene name" style="text-align: center;">
                        <button id='search' class="btn btn-sm mx-1 btn-primary" type="submit">Search</button>
                        <button id='clear' class="btn button-sm btn-secondary">Clear</button>
                    </div>
                </div>
                <div class="d-inline-flex flex-row px-4">
                    <button id="page-left" class="btn btn-sm btn-outline-secondary"><i class="fa fa-angle-double-left"></i></button>
                    <label id="paginate-label" class="page-label px-2 align-self-center" for="page-left"></label>
                    <button id="page-right" class="btn btn-sm btn-outline-secondary"><i class="fa fa-angle-double-right"></i></button>
                </div>
            </div>
        </div>
        <div id='grid' class="ag-theme-balham" style="height: 100%; width: 100%"></div>
        <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    </body>
</html>